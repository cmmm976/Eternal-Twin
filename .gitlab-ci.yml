# demurgos/node:14
image: "demurgos/node@sha256:6112dd5193b5d0c6f521f3eb0b4031710899e3866b72b308ae67f83210978e26"

services:
  - "postgres:latest"

cache:
  paths:
    - "node_modules/"

variables:
  POSTGRES_DB: "etwindb"
  POSTGRES_USER: "runner"
  POSTGRES_PASSWORD: "dev"

before_script:
  - "node --version"
  - "npm --version"
  - "yarn --version"
  - "rustup --version"
  - "cargo --version"
  - "rustc --version"
  - "yarn install --quiet"
  - |
    cat >etwin.toml <<EOL
    [etwin]
    api = "postgres"
    secret = "dev_secret"
    http_port = 50320
    external_uri = "http://localhost:50320"

    [db]
    host = "postgres"
    port = 5432
    name = "${POSTGRES_DB}"
    user = "${POSTGRES_USER}"
    password = "${POSTGRES_PASSWORD}"

    [clients.eternalfest]
    display_name = "Eternalfest"
    app_uri = "http://localhost:50313"
    callback_uri = "http://localhost:50313/oauth/callback"
    secret = "eternalfest_secret"

    [auth.twinoid]
    client_id = "380"
    secret = "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"

    [forum]
    posts_per_page = 10
    threads_per_page = 20

    [forum.sections.fr_main]
    display_name = "Forum Général"
    locale = "fr-FR"
    EOL

stages:
  - "ci"

ci:
  stage: "ci"
  script:
    - "yarn run lint"
    - "yarn --cwd packages/auth-in-memory run test"
    - "yarn --cwd packages/auth-pg run test"
    - "yarn --cwd packages/core run test"
    - "yarn --cwd packages/email-in-memory run test"
    - "yarn --cwd packages/email-template-etwin run test"
    - "yarn --cwd packages/email-template-json run test"
    - "yarn --cwd packages/etwin-client-in-memory run test"
    - "yarn --cwd packages/etwin-pg run prestart"
    - "yarn --cwd packages/forum-in-memory run test"
    - "yarn --cwd packages/forum-pg run test"
    - "yarn --cwd packages/hammerfest-http run test"
    - "yarn --cwd packages/hammerfest-in-memory run test"
    - "yarn --cwd packages/local-config run test"
    - "yarn --cwd packages/oauth-client-http run test"
    - "yarn --cwd packages/oauth-provider-in-memory run test"
    - "yarn --cwd packages/oauth-provider-pg run test"
    - "yarn --cwd packages/password-scrypt run test"
    - "yarn --cwd packages/rest-server run test"
    - "yarn --cwd packages/twinoid-client-http run test"
    - "yarn --cwd packages/twinoid-core run test"
    - "yarn --cwd packages/user-in-memory run test"
    - "yarn --cwd packages/user-pg run test"
    - "yarn --cwd packages/uuid4-generator run test"
    - 'yarn --cwd packages/website run main:build'
